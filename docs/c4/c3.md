# C4 Model - Level 3: Component Diagram

**System**: Surfingkeys Browser Extension
**Diagram Level**: C3 - Component
**Version**: 1.17.12
**Last Updated**: 2026-01-20

## Overview

This diagram decomposes each container into its internal components, showing how responsibilities are distributed across modules and classes within each container.

---

## Container 1: Content Script Engine

The Content Script Engine is the main orchestrator injected into every web page, comprising 14 major components across ~7,100 lines of code.

### Component Diagram

```
┌────────────────────────────────────────────────────────────────────┐
│                    Content Script Engine Container                 │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                  API Component                               │  │
│  │  [api.js - 23KB, ~700 LOC]                                   │  │
│  │                                                               │  │
│  │  User-facing extension API for customization                 │  │
│  │                                                               │  │
│  │  Exports:                                                     │  │
│  │  - mapkey(keys, annotation, fn, opts)                        │  │
│  │  - vmapkey(keys, annotation, fn, opts)                       │  │
│  │  - imapkey(keys, annotation, fn, opts)                       │  │
│  │  - map(new, old) / vmap() / imap()                           │  │
│  │  - unmap(keys) / vunmap() / iunmap()                         │  │
│  │  - cmap(new, old) - Omnibar mappings                         │  │
│  │  - lmap(new, old) - Lurk mode mappings                       │  │
│  │  - addSearchAlias(alias, prompt, url, suggestionURL)         │  │
│  │  - removeSearchAlias(alias)                                  │  │
│  │  - Front.* - UI operations                                   │  │
│  │  - Hints.* - Hints customization                             │  │
│  │  - Clipboard.* - Clipboard operations                        │  │
│  │  - Normal.* / Visual.* - Mode-specific APIs                  │  │
│  │                                                               │  │
│  │  Dependencies: Mode, Trie, KeyboardUtils, all other modules  │  │
│  └────────────┬─────────────────────────────────────────────────┘  │
│               │                                                      │
│               ▼                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                  ModeManager                                 │  │
│  │  [mode.js - 13KB, ~250 LOC]                                  │  │
│  │                                                               │  │
│  │  Mode state management and event routing                     │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Mode stack management (priority-based)                    │  │
│  │  - Event listener registration and routing                   │  │
│  │  - Status line display coordination                          │  │
│  │  - Mode transition lifecycle hooks                           │  │
│  │                                                               │  │
│  │  Class: Mode(name, statusLine)                               │  │
│  │    Properties:                                                │  │
│  │    - name: string - Mode identifier                          │  │
│  │    - statusLine: string - Display text                       │  │
│  │    - priority: number - Stack ordering                       │  │
│  │    - mappings: Trie - Key bindings for this mode             │  │
│  │    - eventListeners: object - Event handlers                 │  │
│  │                                                               │  │
│  │    Methods:                                                   │  │
│  │    - addEventListener(evtName, handler)                      │  │
│  │    - enter(priority, reentrant) - Push to stack              │  │
│  │    - exit(peek) - Pop from stack                             │  │
│  │    - onEnter() / onExit() - Lifecycle hooks                  │  │
│  │                                                               │  │
│  │  Mode Stack: [Top] PassThrough → Insert → Visual → Normal    │  │
│  │                                                               │  │
│  │  Dependencies: Runtime, KeyboardUtils, Utils                 │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │               NormalMode                                     │  │
│  │  [normal.js - 35KB, ~1000 LOC]                               │  │
│  │                                                               │  │
│  │  Normal mode operations - default mode                       │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Page navigation (scroll up/down, top/bottom)              │  │
│  │  - History navigation (back/forward)                         │  │
│  │  - Link navigation (follow links, open URLs)                 │  │
│  │  - Tab operations delegation to Background                   │  │
│  │  - Mode switching (activate Visual, Insert, Hints)           │  │
│  │  - Command execution (: commands)                            │  │
│  │  - Repeat actions with number prefixes (3j, 5d)              │  │
│  │  - Dot repeat (repeat last action)                           │  │
│  │  - Vim marks (create/jump to marks)                          │  │
│  │  - Bookmark/history access                                   │  │
│  │  - URL manipulation (edit, copy)                             │  │
│  │  - Zoom control                                               │  │
│  │  - Frame switching                                            │  │
│  │  - PassThrough/Lurk mode activation                          │  │
│  │                                                               │  │
│  │  Key Functions:                                               │  │
│  │  - Normal.scroll(type, direction, size)                      │  │
│  │  - Normal.jumpVIMark(mark, ctrl)                             │  │
│  │  - Normal.openOmnibar(args)                                  │  │
│  │  - Normal.passThrough(timeout)                               │  │
│  │  - Normal.repeatLast()                                       │  │
│  │  - Normal.hideKeystroke()                                    │  │
│  │  - Normal.showUsage()                                        │  │
│  │                                                               │  │
│  │  ~80 default key mappings defined in default.js              │  │
│  │                                                               │  │
│  │  Dependencies: Front, Runtime, Utils, Hints, Visual, Insert  │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              VisualMode                                      │  │
│  │  [visual.js - 28KB, ~800 LOC]                                │  │
│  │                                                               │  │
│  │  Text selection and manipulation                             │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Text selection (Caret mode / Range mode)                  │  │
│  │  - Vim-like cursor movement (hjkl, w, b, e, 0, $, gg, G)     │  │
│  │  - Large cursor rendering for visibility                     │  │
│  │  - Find character navigation (f/F + char)                    │  │
│  │  - Repeat find (;/,)                                         │  │
│  │  - Center cursor (zz)                                         │  │
│  │  - Search selected text                                       │  │
│  │  - Translate selected text (Google Translate)                │  │
│  │  - Copy selected text to clipboard                           │  │
│  │  - Word search in visual mode (*)                            │  │
│  │  - Select word/line/sentence/paragraph                       │  │
│  │  - Yank and restore position                                 │  │
│  │                                                               │  │
│  │  States:                                                      │  │
│  │  - Caret: Move cursor without selecting text                 │  │
│  │  - Range: Extend selection as cursor moves                   │  │
│  │                                                               │  │
│  │  Key Functions:                                               │  │
│  │  - Visual.toggle()                                           │  │
│  │  - Visual.moveCursor(direction, unit)                        │  │
│  │  - Visual.selectWord() / selectLine() / selectAll()          │  │
│  │  - Visual.findCharacter(char, backward)                      │  │
│  │  - Visual.yankSelection()                                    │  │
│  │  - Visual.feedkeys(keys)                                     │  │
│  │  - Visual.visualEnter(mode)                                  │  │
│  │  - Visual.visualUpdate()                                     │  │
│  │                                                               │  │
│  │  ~30 default key mappings                                    │  │
│  │                                                               │  │
│  │  Dependencies: Clipboard, Front, Runtime, Utils              │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │               HintsMode                                      │  │
│  │  [hints.js - 36KB, ~1000 LOC]                                │  │
│  │                                                               │  │
│  │  Link following and element hints                            │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Clickable element detection (links, buttons, inputs)      │  │
│  │  - Hint label generation and rendering                       │  │
│  │  - Hint character filtering as user types                    │  │
│  │  - Link activation (click, open new tab/window)              │  │
│  │  - Continuous following mode (cf)                            │  │
│  │  - Active element following (af)                             │  │
│  │  - Regional hints mode (L - pick large elements)             │  │
│  │  - Hint overlapping management (Shift to flip)               │  │
│  │  - Hold hints temporarily (Space)                            │  │
│  │  - Customizable hint characters                              │  │
│  │  - Hint alignment (left/center/right)                        │  │
│  │                                                               │  │
│  │  Key Functions:                                               │  │
│  │  - Hints.create(cssSelector, onHintKey, attrs)               │  │
│  │  - Hints.setCharacters(chars)                                │  │
│  │  - Hints.dispatchMouseClick(element, modifierKeys)           │  │
│  │  - Hints.exit()                                              │  │
│  │  - Hints.style(css, mode)                                    │  │
│  │  - Hints.click(links, force)                                 │  │
│  │                                                               │  │
│  │  Hint Types:                                                  │  │
│  │  - Primary (f): Follow link                                  │  │
│  │  - New tab (C-f): Open in new tab                            │  │
│  │  - Active (af): Activate and keep focus                      │  │
│  │  - Continuous (cf): Don't close after click                  │  │
│  │  - Regional (L): Pick large elements                         │  │
│  │  - Input (i): Focus input fields                             │  │
│  │  - Hover (q): Hover over elements                            │  │
│  │  - Download (ya): Download link                              │  │
│  │                                                               │  │
│  │  Default characters: "asdfgqwertzxcvb"                       │  │
│  │                                                               │  │
│  │  Dependencies: Front (rendering), Utils, Runtime             │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              InsertMode                                      │  │
│  │  [insert.js - 13KB, ~400 LOC]                                │  │
│  │                                                               │  │
│  │  Input field handling and editing                            │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Auto-activation when focusing editable elements           │  │
│  │  - Line editing shortcuts (Emacs-style)                      │  │
│  │  - Emoji completion (: + chars triggers picker)              │  │
│  │  - Quote toggling (Ctrl-' in search boxes)                   │  │
│  │  - Open vim/neovim editor (Ctrl-i)                           │  │
│  │  - Focus management (stealFocusOnLoad)                       │  │
│  │  - Editable body detection (contentEditable)                 │  │
│  │  - Input element detection (input, textarea, select)         │  │
│  │                                                               │  │
│  │  Key Functions:                                               │  │
│  │  - Insert.enter(target)                                      │  │
│  │  - Insert.exit()                                             │  │
│  │  - Insert.toggleQuotes()                                     │  │
│  │  - Insert.openEditor(target, useNeovim)                      │  │
│  │  - Insert.emojiCompletion(input)                             │  │
│  │  - Insert.moveCursor(direction, unit)                        │  │
│  │  - Insert.deleteText(direction, unit)                        │  │
│  │                                                               │  │
│  │  Line Editing Shortcuts (Emacs-style):                       │  │
│  │  - Ctrl-a: Move to beginning of line                         │  │
│  │  - Ctrl-e: Move to end of line                               │  │
│  │  - Ctrl-u: Delete to beginning                               │  │
│  │  - Alt-b: Move word backward                                 │  │
│  │  - Alt-f: Move word forward                                  │  │
│  │  - Alt-w: Delete word backward                               │  │
│  │  - Alt-d: Delete word forward                                │  │
│  │                                                               │  │
│  │  Dependencies: Front (emoji picker, editor), Runtime         │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │            ClipboardManager                                  │  │
│  │  [clipboard.js - 3KB, ~100 LOC]                              │  │
│  │                                                               │  │
│  │  System clipboard operations                                 │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Write text to system clipboard                            │  │
│  │  - Read text from system clipboard                           │  │
│  │  - Copy various formats (URLs, titles, HTML, JSON)           │  │
│  │  - Paste operations                                           │  │
│  │  - Browser clipboard API integration                         │  │
│  │                                                               │  │
│  │  Key Functions:                                               │  │
│  │  - Clipboard.write(text)                                     │  │
│  │  - Clipboard.read(onReady)                                   │  │
│  │  - Clipboard.writeHTML(html)                                 │  │
│  │  - Clipboard.createSKElement(text, html)                     │  │
│  │                                                               │  │
│  │  Integration:                                                 │  │
│  │  - Uses browser Clipboard API (navigator.clipboard)          │  │
│  │  - Fallback to execCommand for older browsers                │  │
│  │  - Requires clipboardRead/clipboardWrite permissions         │  │
│  │                                                               │  │
│  │  Dependencies: Browser Clipboard API                         │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │             KeyboardUtils                                    │  │
│  │  [keyboardUtils.js - 9KB, ~250 LOC]                          │  │
│  │                                                               │  │
│  │  Keyboard event processing                                   │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Keyboard event normalization across browsers              │  │
│  │  - Keystroke encoding (parse "<Ctrl-a>" notation)            │  │
│  │  - Keystroke decoding (KeyboardEvent to internal code)       │  │
│  │  - Modifier key detection (Ctrl, Alt, Shift, Meta)           │  │
│  │  - Special key handling (Enter, Esc, Tab, Space, etc.)       │  │
│  │  - Key sequence parsing (gg, ZZ, etc.)                       │  │
│  │  - Word character detection for movement                     │  │
│  │                                                               │  │
│  │  Key Functions:                                               │  │
│  │  - KeyboardUtils.encodeKeystroke(str) - Parse notation       │  │
│  │  - KeyboardUtils.decodeKeystroke(event) - Event to code      │  │
│  │  - KeyboardUtils.isWordChar(char)                            │  │
│  │  - KeyboardUtils.isSKKey(event)                              │  │
│  │  - KeyboardUtils.getKeyChar(event)                           │  │
│  │                                                               │  │
│  │  Key Notation Examples:                                       │  │
│  │  - "<Ctrl-a>" → Ctrl+A internal code                         │  │
│  │  - "<Alt-f>" → Alt+F internal code                           │  │
│  │  - "<Shift-Esc>" → Shift+Esc internal code                   │  │
│  │  - "gg" → Two 'g' keypresses sequence                        │  │
│  │  - "3j" → Number 3 + j sequence                              │  │
│  │                                                               │  │
│  │  Dependencies: None (pure utility)                           │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                  Trie                                        │  │
│  │  [trie.js - 3KB, ~100 LOC]                                   │  │
│  │                                                               │  │
│  │  Key mapping data structure                                  │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Efficient key sequence storage and lookup                 │  │
│  │  - Prefix matching for multi-key sequences                   │  │
│  │  - Mapping add/remove/find operations                        │  │
│  │  - Handle both single keys and sequences (j vs gg)           │  │
│  │  - Detect conflicts (mapping "g" and "gg")                   │  │
│  │                                                               │  │
│  │  Class: Trie()                                               │  │
│  │    Properties:                                                │  │
│  │    - _trie: object - Tree structure                          │  │
│  │                                                               │  │
│  │    Methods:                                                   │  │
│  │    - add(keys, value) - Add key mapping                      │  │
│  │    - find(keys) - Find exact match                           │  │
│  │    - remove(keys) - Remove mapping                           │  │
│  │    - findPrefix(keys) - Find partial match                   │  │
│  │    - getMetas(filter) - Get all mappings with filter         │  │
│  │                                                               │  │
│  │  Performance:                                                 │  │
│  │  - O(L) lookup, L = key sequence length                      │  │
│  │  - Memory efficient for 140+ mappings per mode               │  │
│  │  - Handles prefix conflicts gracefully                       │  │
│  │                                                               │  │
│  │  Dependencies: None (pure data structure)                    │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                  Utils                                       │  │
│  │  [utils.js - 37KB, ~1100 LOC]                                │  │
│  │                                                               │  │
│  │  Shared utility functions                                    │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - DOM manipulation and queries                              │  │
│  │  - Element visibility detection                              │  │
│  │  - Scrolling utilities (smooth scroll, scroll targets)       │  │
│  │  - URL parsing and construction                              │  │
│  │  - String formatting and manipulation                        │  │
│  │  - Browser detection (Chrome/Firefox/Safari)                 │  │
│  │  - Clickable element detection                               │  │
│  │  - Annotation parsing (feature groups)                       │  │
│  │  - HTTP request wrapper                                      │  │
│  │  - UI helper functions                                       │  │
│  │                                                               │  │
│  │  Key Functions:                                               │  │
│  │  - getVisibleElements(selector)                              │  │
│  │  - isElementPartiallyInViewport(el)                          │  │
│  │  - scrollIntoViewIfNeeded(element, options)                  │  │
│  │  - constructSearchURL(se, query)                             │  │
│  │  - getBrowserName()                                          │  │
│  │  - getClickableElements(filter)                              │  │
│  │  - showBanner(msg, timeout)                                  │  │
│  │  - showPopup(content)                                        │  │
│  │  - httpRequest(url, options)                                 │  │
│  │  - tabOpenLink(url, options)                                 │  │
│  │  - generateQuickGuid()                                       │  │
│  │  - parseAnnotation(annotation)                               │  │
│  │                                                               │  │
│  │  Dependencies: Front (for UI), Runtime                       │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                Runtime                                       │  │
│  │  [runtime.js - 6KB, ~150 LOC]                                │  │
│  │                                                               │  │
│  │  Cross-context communication bridge                          │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Background Service communication                          │  │
│  │  - Frontend UI Frame communication                           │  │
│  │  - Top frame communication (nested frames)                   │  │
│  │  - Custom event dispatching                                  │  │
│  │  - Message routing between contexts                          │  │
│  │  - Settings synchronization                                  │  │
│  │                                                               │  │
│  │  Objects:                                                     │  │
│  │  - RUNTIME.sendMessage(msg, callback)                        │  │
│  │  - RUNTIME.onMessage(handler)                                │  │
│  │  - runtime.postMessage(msg) - To frontend UI                 │  │
│  │  - runtime.postTopMessage(msg) - To top frame                │  │
│  │  - dispatchSKEvent(name, data) - Custom events               │  │
│  │  - runtime.conf - Runtime configuration                      │  │
│  │                                                               │  │
│  │  Communication Patterns:                                      │  │
│  │  - Content → Background: chrome.runtime.sendMessage()        │  │
│  │  - Content → Frontend UI: window.postMessage()               │  │
│  │  - Frame → Top frame: parent.postMessage()                   │  │
│  │  - Custom events: window.dispatchEvent()                     │  │
│  │                                                               │  │
│  │  Dependencies: Browser Runtime API                           │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │            DefaultMappings                                   │  │
│  │  [default.js - 35KB, ~900 LOC]                               │  │
│  │                                                               │  │
│  │  Default keyboard shortcuts                                  │  │
│  │                                                               │  │
│  │  Defines 142+ default keyboard shortcuts organized by        │  │
│  │  feature groups (0-14)                                       │  │
│  │                                                               │  │
│  │  Feature Groups:                                              │  │
│  │  - 0: Help and Settings                                      │  │
│  │  - 1: Mouse simulation                                       │  │
│  │  - 2: Page navigation                                        │  │
│  │  - 3: Tabs                                                   │  │
│  │  - 4: Page control                                           │  │
│  │  - 5: Sessions                                                │  │
│  │  - 6: Search selected                                        │  │
│  │  - 7: Clipboard                                               │  │
│  │  - 8: Omnibar                                                 │  │
│  │  - 9: Visual mode                                             │  │
│  │  - 10: Vim marks                                              │  │
│  │  - 11: Settings                                               │  │
│  │  - 12: Chrome URLs                                            │  │
│  │  - 13: Proxy                                                  │  │
│  │  - 14: Miscellaneous                                          │  │
│  │                                                               │  │
│  │  Dependencies: API, all mode components                      │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │            CursorPrompt                                      │  │
│  │  [cursorPrompt.js - 7KB, ~200 LOC]                           │  │
│  │                                                               │  │
│  │  Single-character input prompt                               │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Prompt user for single character input                    │  │
│  │  - Display prompt message                                    │  │
│  │  - Timeout handling                                           │  │
│  │  - Key capture for commands requiring argument               │  │
│  │                                                               │  │
│  │  Use Cases:                                                   │  │
│  │  - Find character (f/F + char)                               │  │
│  │  - Create vim mark (m + char)                                │  │
│  │  - Jump to mark (' + char)                                   │  │
│  │  - Any command needing single key argument                   │  │
│  │                                                               │  │
│  │  Dependencies: Front (for UI), Runtime                       │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │               Observer                                       │  │
│  │  [observer.js - 2KB, ~70 LOC]                                │  │
│  │                                                               │  │
│  │  DOM mutation observer                                       │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Watch for DOM changes                                     │  │
│  │  - Detect dynamically created frames                         │  │
│  │  - Re-inject content scripts into new frames                 │  │
│  │  - Monitor for new editable elements                         │  │
│  │  - Trigger auto-focus handling                               │  │
│  │                                                               │  │
│  │  Uses: MutationObserver API                                  │  │
│  │  Dependencies: InsertMode                                    │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │            DebugUtils                                        │  │
│  │  [debug_utils.js - 1KB, ~40 LOC]                             │  │
│  │                                                               │  │
│  │  Debugging and logging utilities                             │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Structured logging (LOG function)                         │  │
│  │  - Error reporting                                            │  │
│  │  - Performance profiling                                     │  │
│  │  - Stack trace helpers                                        │  │
│  │                                                               │  │
│  │  Functions:                                                   │  │
│  │  - LOG(level, message, ...args)                              │  │
│  │  - reportIssue(title, description)                           │  │
│  │                                                               │  │
│  │  Dependencies: None                                           │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
└────────────────────────────────────────────────────────────────────┘
```

### Component Interaction Flow

```
User Keystroke Event
         │
         ▼
KeyboardUtils.decodeKeystroke(event)
         │
         ▼
ModeManager.handleStack(eventName, event)
         │
         ├─→ Get top mode from stack
         │
         ▼
Mode.mappings.find(keystroke)
         │
         ├─→ NormalMode.mappings.find(key)
         ├─→ VisualMode.mappings.find(key)
         ├─→ InsertMode.mappings.find(key)
         └─→ HintsMode.mappings.find(key)
         │
         ▼
Execute mapped function
         │
         ├─→ Local action
         │   - Scroll page (no external call)
         │   - Move visual cursor (local)
         │
         ├─→ Frontend UI
         │   - Show hints
         │   - Open omnibar
         │   - Display status
         │   via Runtime.postMessage()
         │
         └─→ Background Service
             - Tab operations
             - Bookmark/history
             - Sessions
             via RUNTIME.sendMessage()
```

---

## Container 2: Frontend UI Frame

The Frontend UI Frame is an isolated iframe providing all visual interface components, comprising 10 major components across ~5,000 lines of code.

### Component Diagram

```
┌────────────────────────────────────────────────────────────────────┐
│                    Frontend UI Frame Container                      │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              FrontendController                              │  │
│  │  [frontend.js - 50KB, ~1400 LOC]                             │  │
│  │                                                               │  │
│  │  Main controller for UI frame                                │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Receive commands from content script                      │  │
│  │  - Route commands to appropriate UI component                │  │
│  │  - Manage UI state (which component is active)               │  │
│  │  - Handle keyboard events in UI context                      │  │
│  │  - Send responses back to content script                     │  │
│  │  - Settings application and updates                          │  │
│  │  - Theme and style management                                │  │
│  │                                                               │  │
│  │  Key Functions:                                               │  │
│  │  - handleAction(msg) - Route action to component             │  │
│  │  - hideAll() - Hide all UI components                        │  │
│  │  - applySettings(settings)                                   │  │
│  │  - updateTheme(css)                                          │  │
│  │                                                               │  │
│  │  Message Handler Actions:                                     │  │
│  │  - openOmnibar, closeOmnibar                                 │  │
│  │  - showHints, hideHints                                      │  │
│  │  - showStatus, hideStatus                                    │  │
│  │  - showBanner, showPopup                                     │  │
│  │  - openEditor, openLLMChat                                   │  │
│  │  - addSearchAlias, removeSearchAlias                         │  │
│  │  - setHintsCharacters                                        │  │
│  │                                                               │  │
│  │  Dependencies: All UI components below                       │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                OmnibarController                             │  │
│  │  [omnibar.js - 54KB, ~1500 LOC]                              │  │
│  │                                                               │  │
│  │  Unified search and command interface                        │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Display searchable list (URLs, bookmarks, tabs, etc.)     │  │
│  │  - Real-time filtering as user types                         │  │
│  │  - Keyboard navigation (Tab, Shift-Tab, arrows)              │  │
│  │  - Pagination (Ctrl-. / Ctrl-, for next/prev page)           │  │
│  │  - Result actions (open, open in new tab, delete)            │  │
│  │  - Multi-select (Ctrl-Enter to keep omnibar open)            │  │
│  │  - Search suggestions (async from search engines)            │  │
│  │  - Command execution (: commands)                            │  │
│  │  - JavaScript evaluation                                      │  │
│  │                                                               │  │
│  │  Omnibar Types:                                               │  │
│  │  - URLs: Search bookmarks and history                        │  │
│  │  - Bookmarks: Search bookmarks only                          │  │
│  │  - History: Search history only                              │  │
│  │  - Tabs: Search open tabs                                    │  │
│  │  - Commands: Search and execute commands                     │  │
│  │  - SearchEngine: Search with selected engine                 │  │
│  │  - UserURLs: User-provided URL list                          │  │
│  │  - LLMChat: AI chat interface                                │  │
│  │                                                               │  │
│  │  Key Functions:                                               │  │
│  │  - Omnibar.open(type, options)                               │  │
│  │  - Omnibar.close()                                           │  │
│  │  - Omnibar.handleInput(query)                                │  │
│  │  - Omnibar.selectNext() / selectPrev()                       │  │
│  │  - Omnibar.executeSelected()                                 │  │
│  │  - Omnibar.deleteSelected()                                  │  │
│  │                                                               │  │
│  │  Features:                                                    │  │
│  │  - Fuzzy matching                                             │  │
│  │  - Result highlighting                                        │  │
│  │  - Favicon display                                            │  │
│  │  - URL suggestions                                            │  │
│  │  - Tab completion                                             │  │
│  │                                                               │  │
│  │  Dependencies: FrontendController                            │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │               HintsRenderer                                  │  │
│  │  [Embedded in frontend.js - ~300 LOC]                        │  │
│  │                                                               │  │
│  │  Hint label display and management                           │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Render hint labels on page elements                       │  │
│  │  - Position hints relative to target elements                │  │
│  │  - Update hints as user types                                │  │
│  │  - Flip hints on Shift (handle overlapping)                  │  │
│  │  - Style hints based on settings                             │  │
│  │  - Clear hints when done                                     │  │
│  │                                                               │  │
│  │  Features:                                                    │  │
│  │  - Alignment: left, center, right                            │  │
│  │  - Character filtering                                        │  │
│  │  - Overlapping detection and flip                            │  │
│  │  - Hold mode (Space to temporarily hide)                     │  │
│  │                                                               │  │
│  │  Dependencies: FrontendController                            │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              StatusBarDisplay                                │  │
│  │  [Embedded in frontend.js - ~200 LOC]                        │  │
│  │                                                               │  │
│  │  Mode status and message display                             │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Display current mode (Normal, Visual, Insert, etc.)       │  │
│  │  - Show mode-specific status (Caret vs Range in Visual)      │  │
│  │  - Display temporary messages                                │  │
│  │  - Show proxy status (if enabled)                            │  │
│  │  - Display rich hints (keystroke help)                       │  │
│  │  - Position and style status bar                             │  │
│  │                                                               │  │
│  │  Elements:                                                    │  │
│  │  - Mode indicator                                             │  │
│  │  - Status message area                                        │  │
│  │  - Rich hints tooltip                                         │  │
│  │                                                               │  │
│  │  Dependencies: FrontendController                            │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                 HelpPopup                                    │  │
│  │  [Embedded in frontend.js - ~400 LOC]                        │  │
│  │                                                               │  │
│  │  Keyboard shortcuts help display                             │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Display all keyboard shortcuts by mode                    │  │
│  │  - Group shortcuts by feature group                          │  │
│  │  - Searchable/filterable list                                │  │
│  │  - Show key bindings and descriptions                        │  │
│  │  - Keyboard navigation in help                               │  │
│  │                                                               │  │
│  │  Display Format:                                              │  │
│  │  - Organized by mode (Normal, Visual, Insert)                │  │
│  │  - Feature groups (Help, Navigation, Tabs, etc.)             │  │
│  │  - Key binding + description                                 │  │
│  │                                                               │  │
│  │  Triggered by: ? or u key                                    │  │
│  │                                                               │  │
│  │  Dependencies: FrontendController                            │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              LLMChatInterface                                │  │
│  │  [llmchat.js - 11KB, ~350 LOC]                               │  │
│  │                                                               │  │
│  │  AI/LLM chat interface                                       │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Display chat conversation (user + AI messages)            │  │
│  │  - Handle user input (chat text box)                         │  │
│  │  - Send messages to Background Service for LLM API calls     │  │
│  │  - Stream AI responses in real-time                          │  │
│  │  - Render markdown in AI responses                           │  │
│  │  - Manage chat history                                       │  │
│  │  - Copy code blocks from responses                           │  │
│  │  - Clear chat history                                         │  │
│  │                                                               │  │
│  │  Features:                                                    │  │
│  │  - Multi-turn conversations                                   │  │
│  │  - Code syntax highlighting                                  │  │
│  │  - Markdown rendering                                         │  │
│  │  - Streaming responses                                        │  │
│  │  - Context injection (selected text, page content)           │  │
│  │  - Custom system prompts                                     │  │
│  │                                                               │  │
│  │  Triggered by: A key (with/without selection)                │  │
│  │                                                               │  │
│  │  Dependencies: FrontendController, marked.js                 │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                  FindBar                                     │  │
│  │  [Embedded in frontend.js - ~200 LOC]                        │  │
│  │                                                               │  │
│  │  In-page find interface                                      │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Display find input box                                    │  │
│  │  - Highlight matches as user types                           │  │
│  │  - Navigate matches (n/N for next/previous)                  │  │
│  │  - Case sensitive / regex search support                     │  │
│  │  - Match count display                                       │  │
│  │  - Whole word search (Ctrl-Enter)                            │  │
│  │                                                               │  │
│  │  Features:                                                    │  │
│  │  - Live highlighting                                          │  │
│  │  - Current match indicator                                    │  │
│  │  - Total matches count                                        │  │
│  │  - Regex support                                              │  │
│  │                                                               │  │
│  │  Triggered by: / key                                         │  │
│  │                                                               │  │
│  │  Dependencies: FrontendController                            │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                 EditorUI                                     │  │
│  │  [Embedded in frontend.js - ~500 LOC]                        │  │
│  │                                                               │  │
│  │  Vim/Emacs editor interface (ACE-based)                      │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Initialize ACE editor instance                            │  │
│  │  - Set vim or emacs keybindings                              │  │
│  │  - Display editor for various contexts:                      │  │
│  │    • Input field editing                                     │  │
│  │    • Textarea editing                                        │  │
│  │    • Select dropdown navigation                              │  │
│  │    • URL editing                                             │  │
│  │    • Settings editing                                        │  │
│  │  - Handle save (:w or Ctrl-Enter)                            │  │
│  │  - Handle quit (:q or Esc)                                   │  │
│  │  - Tab completion for URLs/words                             │  │
│  │  - Syntax highlighting                                        │  │
│  │                                                               │  │
│  │  Editor Modes:                                                │  │
│  │  - Single line (for input fields)                            │  │
│  │  - Multi-line (for textareas)                                │  │
│  │  - Selection (for select elements)                           │  │
│  │                                                               │  │
│  │  Triggered by: Ctrl-i in insert mode, or capital I           │  │
│  │                                                               │  │
│  │  Dependencies: ACE Editor library, FrontendController        │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │            BannerNotifications                               │  │
│  │  [Embedded in frontend.js - ~100 LOC]                        │  │
│  │                                                               │  │
│  │  Toast-style notifications                                   │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Display temporary notifications                           │  │
│  │  - Auto-dismiss after timeout                                │  │
│  │  - Queue multiple notifications                              │  │
│  │  - Position banner (top of page)                             │  │
│  │  - Style and animate banner                                  │  │
│  │                                                               │  │
│  │  Use Cases:                                                   │  │
│  │  - Copy confirmation ("Copied to clipboard")                 │  │
│  │  - Error messages                                             │  │
│  │  - Action feedback                                            │  │
│  │                                                               │  │
│  │  Dependencies: FrontendController                            │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │               EmojiPicker                                    │  │
│  │  [Embedded in frontend.js - ~200 LOC]                        │  │
│  │                                                               │  │
│  │  Emoji autocomplete interface                                │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Show emoji suggestions when user types : + chars          │  │
│  │  - Filter emoji by name/keywords                             │  │
│  │  - Display emoji with name                                   │  │
│  │  - Handle emoji selection (Tab/Enter)                        │  │
│  │  - Insert emoji at cursor position                           │  │
│  │                                                               │  │
│  │  Emoji Data:                                                  │  │
│  │  - Loaded from emoji.tsv (1000+ emoji)                       │  │
│  │  - Searchable by name and aliases                            │  │
│  │                                                               │  │
│  │  Triggered by: : + 2 chars in insert mode                    │  │
│  │                                                               │  │
│  │  Dependencies: FrontendController, emoji.tsv                 │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │             MessageHandler                                   │  │
│  │  [Embedded in frontend.js - ~150 LOC]                        │  │
│  │                                                               │  │
│  │  PostMessage communication handler                           │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Listen for postMessage events                             │  │
│  │  - Validate message origin                                   │  │
│  │  - Route messages to FrontendController                      │  │
│  │  - Send responses back to content script                     │  │
│  │  - Handle callbacks (ack messages)                           │  │
│  │                                                               │  │
│  │  Security:                                                    │  │
│  │  - Origin verification                                        │  │
│  │  - Message structure validation                              │  │
│  │                                                               │  │
│  │  Dependencies: FrontendController                            │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
└────────────────────────────────────────────────────────────────────┘
```

---

## Container 3: Background Service

The Background Service is the central coordinator for browser-level operations, comprising 11 major components across ~2,000 lines of code.

### Component Diagram

```
┌────────────────────────────────────────────────────────────────────┐
│                   Background Service Container                      │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              MessageRouter                                   │  │
│  │  [start.js - ~200 LOC]                                       │  │
│  │                                                               │  │
│  │  Central message dispatcher                                  │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Listen for messages from content scripts                  │  │
│  │  - Route messages to appropriate component                   │  │
│  │  - Aggregate responses                                        │  │
│  │  - Handle message callbacks                                  │  │
│  │  - Error handling and logging                                │  │
│  │                                                               │  │
│  │  Message Types:                                               │  │
│  │  - queryTabs, openTab, closeTab, switchTab, etc.             │  │
│  │  - getBookmarks, createBookmark, removeBookmark              │  │
│  │  - getHistory, searchHistory                                 │  │
│  │  - saveSession, restoreSession                               │  │
│  │  - setProxy, getProxySettings                                │  │
│  │  - queryLLM                                                   │  │
│  │  - saveSettings, getSettings                                 │  │
│  │                                                               │  │
│  │  Dependencies: All other components                          │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                 TabManager                                   │  │
│  │  [start.js - ~500 LOC]                                       │  │
│  │                                                               │  │
│  │  Tab lifecycle and organization                              │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Query tabs (all, current window, by URL pattern)          │  │
│  │  - Create tabs (new, duplicate)                              │  │
│  │  - Close tabs (single, pattern-based, others)                │  │
│  │  - Switch tabs (by index, next/prev, MRU order)              │  │
│  │  - Move tabs (reorder, to beginning/end)                     │  │
│  │  - Pin/unpin tabs                                             │  │
│  │  - Mute/unmute tabs                                           │  │
│  │  - Reload tabs                                                │  │
│  │  - Get recently closed tabs                                  │  │
│  │  - Restore recently closed tabs                              │  │
│  │  - Tab groups (Chrome only)                                  │  │
│  │                                                               │  │
│  │  Key Functions:                                               │  │
│  │  - queryTabs(options)                                        │  │
│  │  - createTab(url, options)                                   │  │
│  │  - closeTab(tabId, options)                                  │  │
│  │  - switchTab(tabId)                                          │  │
│  │  - moveTab(tabId, position)                                  │  │
│  │  - pinTab(tabId) / unpinTab(tabId)                           │  │
│  │  - muteTab(tabId) / unmuteTab(tabId)                         │  │
│  │                                                               │  │
│  │  Uses: chrome.tabs.* API                                     │  │
│  │  Dependencies: MessageRouter                                 │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │               WindowManager                                  │  │
│  │  [start.js - ~200 LOC]                                       │  │
│  │                                                               │  │
│  │  Window management operations                                │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Query windows (all, current, focused)                     │  │
│  │  - Create windows (normal, incognito, popup)                 │  │
│  │  - Move tabs between windows                                 │  │
│  │  - Gather tabs to current window                             │  │
│  │  - Focus windows                                              │  │
│  │  - Close windows                                              │  │
│  │                                                               │  │
│  │  Key Functions:                                               │  │
│  │  - queryWindows(options)                                     │  │
│  │  - createWindow(options)                                     │  │
│  │  - moveTabToWindow(tabId, windowId)                          │  │
│  │  - gatherTabs(filter)                                        │  │
│  │                                                               │  │
│  │  Uses: chrome.windows.* API                                  │  │
│  │  Dependencies: MessageRouter, TabManager                     │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              BookmarkManager                                 │  │
│  │  [start.js - ~300 LOC]                                       │  │
│  │                                                               │  │
│  │  Bookmark operations                                         │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Query bookmarks (search, get tree)                        │  │
│  │  - Create bookmarks (with folder selection)                  │  │
│  │  - Remove bookmarks                                           │  │
│  │  - Update bookmarks (title, URL)                             │  │
│  │  - Create folders                                             │  │
│  │  - Vim-like marks (store URL bookmarks with single char)     │  │
│  │                                                               │  │
│  │  Key Functions:                                               │  │
│  │  - queryBookmarks(query)                                     │  │
│  │  - createBookmark(title, url, folderId)                      │  │
│  │  - removeBookmark(bookmarkId)                                │  │
│  │  - createVimMark(char, url)                                  │  │
│  │  - jumpToVimMark(char)                                       │  │
│  │                                                               │  │
│  │  Vim Marks Storage:                                           │  │
│  │  - Stored in chrome.storage.local                            │  │
│  │  - Format: {char: url, ...}                                  │  │
│  │                                                               │  │
│  │  Uses: chrome.bookmarks.* API, chrome.storage.* API          │  │
│  │  Dependencies: MessageRouter, SettingsManager                │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              HistoryManager                                  │  │
│  │  [start.js - ~100 LOC]                                       │  │
│  │                                                               │  │
│  │  Browsing history access                                     │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Query history (search, get visits)                        │  │
│  │  - Get top sites                                              │  │
│  │  - Delete history entries                                    │  │
│  │  - Search history by text/URL                                │  │
│  │                                                               │  │
│  │  Key Functions:                                               │  │
│  │  - queryHistory(text, maxResults)                            │  │
│  │  - getTopSites(limit)                                        │  │
│  │  - deleteHistoryEntry(url)                                   │  │
│  │                                                               │  │
│  │  Uses: chrome.history.* API, chrome.topSites.* API           │  │
│  │  Dependencies: MessageRouter                                 │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              SessionManager                                  │  │
│  │  [start.js - ~400 LOC]                                       │  │
│  │                                                               │  │
│  │  Session save and restore                                    │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Save current tabs as session (named or LAST)              │  │
│  │  - Restore session (open all tabs)                           │  │
│  │  - List saved sessions                                       │  │
│  │  - Delete sessions                                            │  │
│  │  - Quick save and quit (ZZ)                                  │  │
│  │  - Quick restore (ZR)                                        │  │
│  │                                                               │  │
│  │  Session Format:                                              │  │
│  │  - {name: string, tabs: [{url, title}, ...], created: date}  │  │
│  │                                                               │  │
│  │  Key Functions:                                               │  │
│  │  - saveSession(name)                                         │  │
│  │  - restoreSession(name)                                      │  │
│  │  - listSessions()                                            │  │
│  │  - deleteSession(name)                                       │  │
│  │                                                               │  │
│  │  Storage: chrome.storage.local (sessions key)                │  │
│  │                                                               │  │
│  │  Uses: chrome.tabs.* API, chrome.storage.* API               │  │
│  │  Dependencies: MessageRouter, TabManager, SettingsManager    │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │             SettingsManager                                  │  │
│  │  [start.js - ~300 LOC]                                       │  │
│  │                                                               │  │
│  │  Extension settings coordination                             │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Load settings from storage                                │  │
│  │  - Save settings to storage                                  │  │
│  │  - Validate settings                                          │  │
│  │  - Broadcast settings changes to tabs                        │  │
│  │  - Export settings (JSON)                                    │  │
│  │  - Import settings (JSON)                                    │  │
│  │  - Reset to defaults                                         │  │
│  │  - Sync coordination (chrome.storage.sync)                   │  │
│  │                                                               │  │
│  │  Settings Categories:                                         │  │
│  │  - Behavioral (smoothScroll, tabsThreshold, etc.)            │  │
│  │  - Visual (hintAlign, theme, omnibarPosition)                │  │
│  │  - Search (defaultSearchEngine, caseSensitive)               │  │
│  │  - Blocklist/lurking patterns                                │  │
│  │  - Proxy configuration                                        │  │
│  │  - LLM credentials                                            │  │
│  │  - User scripts                                               │  │
│  │                                                               │  │
│  │  Key Functions:                                               │  │
│  │  - getSettings(keys)                                         │  │
│  │  - saveSettings(settings)                                    │  │
│  │  - exportSettings()                                          │  │
│  │  - importSettings(json)                                      │  │
│  │                                                               │  │
│  │  Uses: chrome.storage.local, chrome.storage.sync             │  │
│  │  Dependencies: MessageRouter                                 │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              ProxyManager                                    │  │
│  │  [start.js - ~600 LOC, Chrome only]                          │  │
│  │                                                               │  │
│  │  Proxy configuration and control                             │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Set proxy configuration (IP, port, protocol)              │  │
│  │  - Switch proxy modes (direct, byhost, bypass, always, etc.) │  │
│  │  - Maintain per-site proxy list                              │  │
│  │  - Toggle proxy for current site                             │  │
│  │  - Generate PAC script dynamically                           │  │
│  │  - Apply proxy settings to browser                           │  │
│  │                                                               │  │
│  │  Proxy Modes:                                                 │  │
│  │  - direct: No proxy for any site                             │  │
│  │  - byhost: Proxy only for listed sites                       │  │
│  │  - bypass: Proxy for all except listed sites                 │  │
│  │  - always: Proxy for all sites                               │  │
│  │  - system: Use OS proxy settings                             │  │
│  │  - clear: Surfingkeys doesn't manage proxy                   │  │
│  │                                                               │  │
│  │  Key Functions:                                               │  │
│  │  - setProxy(host, port, protocol)                            │  │
│  │  - setProxyMode(mode)                                        │  │
│  │  - toggleProxyForSite(url)                                   │  │
│  │  - getProxySettings()                                        │  │
│  │  - generatePAC()                                             │  │
│  │                                                               │  │
│  │  Storage: chrome.storage.local (proxy key)                   │  │
│  │                                                               │  │
│  │  Uses: chrome.proxy.* API                                    │  │
│  │  Dependencies: MessageRouter, SettingsManager                │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              LLMIntegration                                  │  │
│  │  [llm.js - 21KB, ~600 LOC]                                   │  │
│  │                                                               │  │
│  │  LLM provider API integration                                │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Manage multiple LLM provider connections                  │  │
│  │  - Route chat requests to configured provider                │  │
│  │  - Handle streaming responses                                │  │
│  │  - API authentication (API keys, AWS SigV4)                  │  │
│  │  - Error handling and retry logic                            │  │
│  │  - Parse EventStream (AWS Bedrock)                           │  │
│  │                                                               │  │
│  │  Supported Providers:                                         │  │
│  │  - Ollama (local, http://localhost:11434)                    │  │
│  │  - AWS Bedrock (Claude models, SigV4 auth)                   │  │
│  │  - DeepSeek (API key auth)                                   │  │
│  │  - Gemini (Google, API key auth)                             │  │
│  │  - Custom (OpenAI-compatible APIs)                           │  │
│  │                                                               │  │
│  │  Key Components:                                              │  │
│  │  - EventStreamParser (for Bedrock responses)                 │  │
│  │  - Provider adapters (one per provider)                      │  │
│  │  - Authentication handlers                                    │  │
│  │  - Response streaming                                         │  │
│  │                                                               │  │
│  │  Key Functions:                                               │  │
│  │  - queryLLM(provider, messages, options)                     │  │
│  │  - streamResponse(provider, messages, onChunk)               │  │
│  │  - authenticateProvider(provider, credentials)               │  │
│  │                                                               │  │
│  │  Uses: fetch API, aws4fetch library                          │  │
│  │  Dependencies: MessageRouter, SettingsManager                │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │             CommandExecutor                                  │  │
│  │  [start.js - ~400 LOC]                                       │  │
│  │                                                               │  │
│  │  Command parsing and execution                               │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Parse commands from Omnibar (: commands)                  │  │
│  │  - Execute built-in commands                                 │  │
│  │  - Evaluate JavaScript code (sandboxed)                      │  │
│  │  - Return command results                                    │  │
│  │                                                               │  │
│  │  Built-in Commands:                                           │  │
│  │  - createSession <name>                                      │  │
│  │  - openSession <name>                                        │  │
│  │  - deleteSession <name>                                      │  │
│  │  - listSession                                                │  │
│  │  - setProxy <host:port> [protocol]                           │  │
│  │  - setProxyMode <mode>                                       │  │
│  │  - settings.set <key> <value>                                │  │
│  │  - help / showUsage                                          │  │
│  │                                                               │  │
│  │  JavaScript Evaluation:                                       │  │
│  │  - Eval arbitrary JS in background context                   │  │
│  │  - Access to chrome.* APIs                                   │  │
│  │  - Return value displayed in omnibar                         │  │
│  │                                                               │  │
│  │  Dependencies: All manager components                        │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │          NativeMessagingBridge                               │  │
│  │  [start.js - ~200 LOC, Chrome only]                          │  │
│  │                                                               │  │
│  │  Communication with external Neovim process                  │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Establish native messaging connection to Neovim           │  │
│  │  - Forward messages between Neovim Terminal page and nvim    │  │
│  │  - Handle connection lifecycle (connect, disconnect)         │  │
│  │  - Error handling and reconnection                           │  │
│  │  - Port management                                            │  │
│  │                                                               │  │
│  │  Message Flow:                                                │  │
│  │  Neovim Terminal Page ←→ Background Service ←→ Neovim Process│  │
│  │                                                               │  │
│  │  Key Functions:                                               │  │
│  │  - connectNative()                                           │  │
│  │  - sendToNative(message)                                     │  │
│  │  - onNativeMessage(handler)                                  │  │
│  │  - disconnectNative()                                        │  │
│  │                                                               │  │
│  │  Uses: chrome.runtime.connectNative()                        │  │
│  │  Dependencies: MessageRouter                                 │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │            DownloadManager                                   │  │
│  │  [start.js - ~100 LOC]                                       │  │
│  │                                                               │  │
│  │  File download management                                    │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Initiate downloads (from URL or data URL)                 │  │
│  │  - Track download progress                                   │  │
│  │  - Handle download completion                                │  │
│  │  - Open downloads folder                                     │  │
│  │                                                               │  │
│  │  Use Cases:                                                   │  │
│  │  - Download links (ya hint mode)                             │  │
│  │  - Save page screenshots                                     │  │
│  │  - Export settings as JSON                                   │  │
│  │                                                               │  │
│  │  Key Functions:                                               │  │
│  │  - downloadURL(url, filename)                                │  │
│  │  - downloadDataURL(dataUrl, filename)                        │  │
│  │                                                               │  │
│  │  Uses: chrome.downloads.* API                                │  │
│  │  Dependencies: MessageRouter                                 │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
└────────────────────────────────────────────────────────────────────┘
```

---

## Container 4: Popup Interface

Simple browser action popup, comprising 2 components.

### Component Diagram

```
┌────────────────────────────────────────────────────────────────────┐
│                     Popup Interface Container                       │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              PopupController                                 │  │
│  │  [popup.js - 2KB, ~50 LOC]                                   │  │
│  │                                                               │  │
│  │  Main popup logic                                            │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Query current tab status                                  │  │
│  │  - Display extension status (enabled/lurking/disabled)       │  │
│  │  - Handle quick toggle button                                │  │
│  │  - Open settings page link                                   │  │
│  │  - Communicate with Background Service                       │  │
│  │                                                               │  │
│  │  Key Functions:                                               │  │
│  │  - init() - Initialize popup                                 │  │
│  │  - getStatus() - Get current site status                     │  │
│  │  - toggleSurfingkeys() - Enable/disable for site             │  │
│  │  - openSettings() - Open options page                        │  │
│  │                                                               │  │
│  │  Dependencies: StatusDisplay, Background Service             │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              StatusDisplay                                   │  │
│  │  [popup.html + popup.js - ~30 LOC]                           │  │
│  │                                                               │  │
│  │  Status visualization                                        │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Display icon reflecting status                            │  │
│  │  - Show text status (Enabled/Lurking/Disabled)               │  │
│  │  - Update UI when status changes                             │  │
│  │                                                               │  │
│  │  Status Indicators:                                           │  │
│  │  - Green: Enabled and active                                 │  │
│  │  - Yellow: Lurking mode                                      │  │
│  │  - Gray: Disabled for this site                              │  │
│  │                                                               │  │
│  │  Dependencies: PopupController                               │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
└────────────────────────────────────────────────────────────────────┘
```

---

## Container 5: Options Page

Settings editor page, comprising 4 components.

### Component Diagram

```
┌────────────────────────────────────────────────────────────────────┐
│                      Options Page Container                         │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │             OptionsController                                │  │
│  │  [options.js - 28KB, ~800 LOC]                               │  │
│  │                                                               │  │
│  │  Main options page coordinator                               │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Initialize options page                                   │  │
│  │  - Coordinate between editor and other components            │  │
│  │  - Handle save/load/reset operations                         │  │
│  │  - Apply settings to page                                    │  │
│  │  - Show save confirmation                                    │  │
│  │                                                               │  │
│  │  Key Functions:                                               │  │
│  │  - init() - Initialize page and editor                       │  │
│  │  - loadSettings() - Load settings from storage               │  │
│  │  - saveSettings() - Validate and save settings               │  │
│  │  - resetSettings() - Reset to defaults                       │  │
│  │  - exportSettings() - Download settings as JSON              │  │
│  │  - importSettings() - Upload settings JSON                   │  │
│  │                                                               │  │
│  │  Dependencies: SettingsEditor, Validator, ImportExporter     │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │             SettingsEditor                                   │  │
│  │  [options.js - ACE integration - ~400 LOC]                   │  │
│  │                                                               │  │
│  │  JavaScript code editor with syntax highlighting             │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Initialize ACE editor instance                            │  │
│  │  - Set vim or emacs keybindings                              │  │
│  │  - JavaScript syntax highlighting                            │  │
│  │  - Auto-completion for Surfingkeys API                       │  │
│  │  - Error highlighting (syntax errors)                        │  │
│  │  - Save on :w or Ctrl-S                                      │  │
│  │  - Reset confirmation                                         │  │
│  │                                                               │  │
│  │  Editor Features:                                             │  │
│  │  - Vim/Emacs keybindings                                     │  │
│  │  - Line numbers                                               │  │
│  │  - Code folding                                               │  │
│  │  - Bracket matching                                           │  │
│  │  - Search/replace                                             │  │
│  │                                                               │  │
│  │  Dependencies: ACE Editor library                            │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              SettingsValidator                               │  │
│  │  [options.js - ~200 LOC]                                     │  │
│  │                                                               │  │
│  │  Settings validation before save                             │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Validate JavaScript syntax                                │  │
│  │  - Check for common errors                                   │  │
│  │  - Warn about deprecated APIs                                │  │
│  │  - Validate setting values (types, ranges)                   │  │
│  │  - Show validation errors to user                            │  │
│  │                                                               │  │
│  │  Validation Checks:                                           │  │
│  │  - Syntax errors (parse errors)                              │  │
│  │  - API usage errors                                           │  │
│  │  - Type mismatches                                            │  │
│  │  - Invalid values (e.g., negative scrollStepSize)            │  │
│  │                                                               │  │
│  │  Dependencies: OptionsController                             │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │             ImportExporter                                   │  │
│  │  [options.js - ~200 LOC]                                     │  │
│  │                                                               │  │
│  │  Settings import/export functionality                        │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Export settings to JSON file                              │  │
│  │  - Import settings from JSON file                            │  │
│  │  - Validate imported settings                                │  │
│  │  - Merge imported settings with existing                     │  │
│  │  - Show import/export UI                                     │  │
│  │                                                               │  │
│  │  Export Format:                                               │  │
│  │  - JSON with metadata (version, date)                        │  │
│  │  - All settings including user scripts                       │  │
│  │  - Downloadable as .json file                                │  │
│  │                                                               │  │
│  │  Import:                                                      │  │
│  │  - Upload .json file                                         │  │
│  │  - Validate format and version                               │  │
│  │  - Confirm before applying                                   │  │
│  │                                                               │  │
│  │  Dependencies: OptionsController, DownloadManager            │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
└────────────────────────────────────────────────────────────────────┘
```

---

## Container 6: PDF Viewer

Custom PDF viewer with keyboard navigation (Chrome only), comprising 5 components.

### Component Diagram

```
┌────────────────────────────────────────────────────────────────────┐
│                      PDF Viewer Container                           │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              PDFRenderer                                     │  │
│  │  [pdf_viewer.mjs - PDF.js wrapper - ~2000 LOC]              │  │
│  │                                                               │  │
│  │  PDF.js integration and rendering                            │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Load PDF from URL                                         │  │
│  │  - Initialize PDF.js worker                                  │  │
│  │  - Render PDF pages to canvas                                │  │
│  │  - Handle page rendering lifecycle                           │  │
│  │  - Manage page cache                                         │  │
│  │  - Text layer rendering (for selection)                      │  │
│  │  - Annotation layer rendering                                │  │
│  │                                                               │  │
│  │  Key Functions:                                               │  │
│  │  - loadPDF(url)                                              │  │
│  │  - renderPage(pageNum)                                       │  │
│  │  - getPage(pageNum)                                          │  │
│  │  - cleanup()                                                 │  │
│  │                                                               │  │
│  │  Uses: PDF.js library (pdfjs-dist)                           │  │
│  │  Dependencies: NavigationController, ZoomController          │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │           NavigationController                               │  │
│  │  [pdf_viewer.mjs - ~500 LOC]                                 │  │
│  │                                                               │  │
│  │  PDF page navigation                                         │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Navigate to next/previous page                            │  │
│  │  - Jump to specific page number                              │  │
│  │  - Scroll through pages (j/k scrolling)                      │  │
│  │  - First/last page navigation                                │  │
│  │  - Page number display                                       │  │
│  │  - Handle page links (PDF internal links)                    │  │
│  │                                                               │  │
│  │  Keyboard Shortcuts:                                          │  │
│  │  - j/k: Scroll down/up                                       │  │
│  │  - ]]/[[: Next/previous page                                 │  │
│  │  - gg/G: First/last page                                     │  │
│  │  - Page number input for jump                                │  │
│  │                                                               │  │
│  │  Dependencies: PDFRenderer                                   │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              ZoomController                                  │  │
│  │  [pdf_viewer.mjs - ~300 LOC]                                 │  │
│  │                                                               │  │
│  │  Zoom and scale control                                      │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Zoom in/out (zi/zo)                                       │  │
│  │  - Fit to page width                                         │  │
│  │  - Fit to page height                                        │  │
│  │  - Actual size (100%)                                        │  │
│  │  - Custom zoom level                                         │  │
│  │  - Zoom level display                                        │  │
│  │                                                               │  │
│  │  Zoom Levels:                                                 │  │
│  │  - Predefined: 50%, 75%, 100%, 125%, 150%, 200%, etc.        │  │
│  │  - Custom percentage                                          │  │
│  │  - Fit width / fit height                                    │  │
│  │                                                               │  │
│  │  Dependencies: PDFRenderer                                   │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              SearchInPDF                                     │  │
│  │  [pdf_viewer.mjs - ~400 LOC]                                 │  │
│  │                                                               │  │
│  │  Text search within PDF                                      │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Search text across all pages                              │  │
│  │  - Highlight search results                                  │  │
│  │  - Navigate between matches (n/N)                            │  │
│  │  - Case-sensitive/insensitive search                         │  │
│  │  - Regex search support                                      │  │
│  │  - Match count display                                       │  │
│  │                                                               │  │
│  │  Search Flow:                                                 │  │
│  │  - Extract text from all pages                               │  │
│  │  - Find matches                                               │  │
│  │  - Jump to page with match                                   │  │
│  │  - Highlight match on page                                   │  │
│  │                                                               │  │
│  │  Dependencies: PDFRenderer, NavigationController             │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │            AnnotationHandler                                 │  │
│  │  [pdf_viewer.mjs - ~300 LOC]                                 │  │
│  │                                                               │  │
│  │  PDF annotation support                                      │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Render PDF annotations (links, comments, etc.)            │  │
│  │  - Handle annotation clicks                                  │  │
│  │  - Link navigation (internal and external)                   │  │
│  │  - Annotation highlighting                                    │  │
│  │                                                               │  │
│  │  Annotation Types:                                            │  │
│  │  - Link annotations (internal page refs, external URLs)      │  │
│  │  - Text annotations (comments, notes)                        │  │
│  │  - Highlight annotations                                      │  │
│  │                                                               │  │
│  │  Dependencies: PDFRenderer, NavigationController             │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
└────────────────────────────────────────────────────────────────────┘
```

---

## Container 7: Markdown Preview

Markdown preview and editing page, comprising 3 components.

### Component Diagram

```
┌────────────────────────────────────────────────────────────────────┐
│                   Markdown Preview Container                        │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │            MarkdownParser                                    │  │
│  │  [markdown.js - ~100 LOC]                                    │  │
│  │                                                               │  │
│  │  Markdown to HTML conversion                                 │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Parse markdown text to HTML                               │  │
│  │  - Support CommonMark + GFM (GitHub Flavored Markdown)       │  │
│  │  - Syntax highlighting for code blocks                       │  │
│  │  - Table support                                              │  │
│  │  - Task list support                                          │  │
│  │  - Emoji support                                              │  │
│  │                                                               │  │
│  │  Parser Options:                                              │  │
│  │  - Local: marked.js library (offline)                        │  │
│  │  - Remote: GitHub API (requires internet)                    │  │
│  │                                                               │  │
│  │  Key Functions:                                               │  │
│  │  - parseMarkdown(text, useGitHub)                            │  │
│  │  - highlightCode(code, language)                             │  │
│  │                                                               │  │
│  │  Uses: marked.js library or GitHub API                       │  │
│  │  Dependencies: HTMLRenderer                                  │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              HTMLRenderer                                    │  │
│  │  [markdown.js - ~150 LOC]                                    │  │
│  │                                                               │  │
│  │  Rendered HTML display                                       │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Display rendered HTML in page                             │  │
│  │  - Apply markdown CSS theme                                  │  │
│  │  - Handle link clicks (open in new tab)                      │  │
│  │  - Code block copy buttons                                   │  │
│  │  - Scroll synchronization (if editing)                       │  │
│  │  - Export to HTML file                                       │  │
│  │                                                               │  │
│  │  Features:                                                    │  │
│  │  - Syntax highlighted code blocks                            │  │
│  │  - Clickable links                                            │  │
│  │  - Responsive tables                                          │  │
│  │  - Styled with GitHub markdown CSS                           │  │
│  │                                                               │  │
│  │  Dependencies: MarkdownParser                                │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │            EditorIntegration                                 │  │
│  │  [markdown.js - ~100 LOC]                                    │  │
│  │                                                               │  │
│  │  Markdown editing integration                                │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Load markdown from clipboard (;pm)                        │  │
│  │  - Open vim editor for markdown source (;pm again)           │  │
│  │  - Save and refresh preview (:wq)                            │  │
│  │  - Reload from clipboard (r)                                 │  │
│  │  - Export to HTML file                                       │  │
│  │                                                               │  │
│  │  Workflow:                                                    │  │
│  │  1. ;pm - Load markdown from clipboard, show preview         │  │
│  │  2. ;pm - Open vim editor with markdown source               │  │
│  │  3. Edit in vim                                               │  │
│  │  4. :wq - Save and refresh preview                           │  │
│  │  5. r - Reload from clipboard (discard edits)                │  │
│  │                                                               │  │
│  │  Dependencies: MarkdownParser, HTMLRenderer, Clipboard       │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
└────────────────────────────────────────────────────────────────────┘
```

---

## Container 8: Neovim Terminal

Full Neovim terminal emulator (Chrome only), comprising 6 components.

### Component Diagram

```
┌────────────────────────────────────────────────────────────────────┐
│                    Neovim Terminal Container                        │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │            TerminalRenderer                                  │  │
│  │  [renderer.ts - PixiJS integration - ~400 LOC]               │  │
│  │                                                               │  │
│  │  GPU-accelerated terminal rendering                          │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Initialize PixiJS canvas                                  │  │
│  │  - Render terminal grid (rows × cols)                        │  │
│  │  - Draw characters with proper font/size                     │  │
│  │  - Apply foreground/background colors                        │  │
│  │  - Handle text attributes (bold, italic, underline)          │  │
│  │  - Cursor rendering and blinking                             │  │
│  │  - Smooth scrolling                                           │  │
│  │  - Window resize handling                                    │  │
│  │                                                               │  │
│  │  Features:                                                    │  │
│  │  - True color (24-bit RGB) support                           │  │
│  │  - GPU-accelerated rendering (60+ FPS)                       │  │
│  │  - Font ligatures support                                    │  │
│  │  - Emoji rendering                                            │  │
│  │                                                               │  │
│  │  Uses: PixiJS library (@pixi/*)                              │  │
│  │  Dependencies: ScreenBuffer, ColorManager                    │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │           NvimProtocolHandler                                │  │
│  │  [Nvim.ts - ~500 LOC]                                        │  │
│  │                                                               │  │
│  │  Neovim UI protocol implementation                           │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Implement Neovim UI protocol                              │  │
│  │  - Handle redraw events from Neovim                          │  │
│  │  - Process grid_line, grid_cursor_goto, etc.                │  │
│  │  - Manage multiple grids (main + floating windows)           │  │
│  │  - Handle mode changes (normal, insert, visual, etc.)        │  │
│  │  - Process option changes (guicursor, etc.)                  │  │
│  │                                                               │  │
│  │  Neovim UI Events:                                            │  │
│  │  - grid_line: Update line content                            │  │
│  │  - grid_cursor_goto: Move cursor                             │  │
│  │  - grid_scroll: Scroll region                                │  │
│  │  - grid_resize: Resize grid                                  │  │
│  │  - hl_attr_define: Define highlight attributes               │  │
│  │  - mode_change: Change mode (normal/insert/etc.)             │  │
│  │  - And 20+ other events                                      │  │
│  │                                                               │  │
│  │  Dependencies: TerminalRenderer, WebSocketTransport          │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │           WebSocketTransport                                 │  │
│  │  [transport/websocket.ts - ~200 LOC]                         │  │
│  │                                                               │  │
│  │  WebSocket communication with Neovim                         │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Establish WebSocket connection to Neovim                  │  │
│  │  - Send msgpack-encoded messages to Neovim                   │  │
│  │  - Receive and decode msgpack messages                       │  │
│  │  - Handle connection lifecycle (connect, disconnect, error)  │  │
│  │  - Reconnection logic                                         │  │
│  │  - Message queue for offline state                           │  │
│  │                                                               │  │
│  │  Protocol:                                                    │  │
│  │  - MessagePack RPC over WebSocket                            │  │
│  │  - Request/response pattern                                  │  │
│  │  - Notification pattern (redraw events)                      │  │
│  │                                                               │  │
│  │  Uses: @msgpack/msgpack library                              │  │
│  │  Dependencies: NvimProtocolHandler, Background Service       │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              InputForwarder                                  │  │
│  │  [input/keyboard.ts + input/mouse.ts - ~400 LOC]             │  │
│  │                                                               │  │
│  │  Input event capture and forwarding                          │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Capture keyboard events                                   │  │
│  │  - Capture mouse events (click, scroll, drag)                │  │
│  │  - Convert to Neovim input format                            │  │
│  │  - Send input to Neovim via WebSocket                        │  │
│  │  - Handle special keys (Ctrl, Alt, function keys)            │  │
│  │  - IME (Input Method Editor) support                         │  │
│  │                                                               │  │
│  │  Input Types:                                                 │  │
│  │  - Keyboard: <C-a>, <M-x>, <F1>, etc.                        │  │
│  │  - Mouse: <LeftMouse>, <RightMouse>, <ScrollWheelUp>         │  │
│  │                                                               │  │
│  │  Dependencies: WebSocketTransport                            │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │               ScreenBuffer                                   │  │
│  │  [screen.ts - ~300 LOC]                                      │  │
│  │                                                               │  │
│  │  Terminal grid state management                              │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Maintain terminal grid state (char + attributes per cell) │  │
│  │  - Apply redraw updates to grid                              │  │
│  │  - Handle scrolling (move rows up/down)                      │  │
│  │  - Cursor position tracking                                  │  │
│  │  - Dirty region tracking (for optimized rendering)           │  │
│  │                                                               │  │
│  │  Data Structure:                                              │  │
│  │  - 2D array of cells (rows × cols)                           │  │
│  │  - Each cell: {char, fg, bg, attrs}                          │  │
│  │  - attrs: {bold, italic, underline, reverse, etc.}           │  │
│  │                                                               │  │
│  │  Dependencies: TerminalRenderer                              │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              ColorManager                                    │  │
│  │  [lib/getColor.ts - ~100 LOC]                                │  │
│  │                                                               │  │
│  │  Color palette and conversion                                │  │
│  │                                                               │  │
│  │  Responsibilities:                                            │  │
│  │  - Manage color palette (16 ANSI + true color)               │  │
│  │  - Convert Neovim color format to RGB                        │  │
│  │  - Handle default colors (from colorscheme)                  │  │
│  │  - Cache color conversions                                   │  │
│  │                                                               │  │
│  │  Color Formats:                                               │  │
│  │  - Neovim: Integer RGB (0xRRGGBB)                            │  │
│  │  - PixiJS: 0xRRGGBB or CSS string                            │  │
│  │                                                               │  │
│  │  Dependencies: TerminalRenderer                              │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
└────────────────────────────────────────────────────────────────────┘
```

---

## Component Interaction Patterns

### Pattern 1: User Keystroke to Action

```
Keystroke → Content Script → Mode Stack → Execute Action
                │                              │
                ├─→ Local (scroll, cursor)     │
                ├─→ Frontend UI (hints, etc.)  │
                └─→ Background (tabs, etc.)    │
```

### Pattern 2: Omnibar Search

```
User types 't'
    ↓
Content Script (Normal mode)
    ↓
Frontend UI (OmnibarController)
    ↓
Background Service (BookmarkManager + HistoryManager)
    ↓
Frontend UI (display results)
    ↓
User selects
    ↓
Background Service (TabManager.createTab)
```

### Pattern 3: LLM Chat

```
User selects text → Press 'A'
    ↓
Content Script (send text to frontend)
    ↓
Frontend UI (LLMChatInterface)
    ↓
Background Service (LLMIntegration)
    ↓
External LLM Provider API
    ↓
Background Service (stream response)
    ↓
Frontend UI (render markdown)
```

### Pattern 4: Settings Update

```
User edits settings in Options Page
    ↓
OptionsController.saveSettings()
    ↓
Background Service (SettingsManager)
    ↓
Browser Storage (chrome.storage.sync)
    ↓
Broadcast to all tabs
    ↓
Content Scripts reload settings
```

---

## Technology Summary

### Languages
- JavaScript (ES6+) - Content scripts, background, UI
- TypeScript - Neovim terminal components
- HTML5 - All pages and UI
- CSS3 - Styling with Shadow DOM

### Libraries & Frameworks
- **ACE Editor** (ace-builds) - Vim/Emacs editor
- **PDF.js** (pdfjs-dist) - PDF rendering
- **marked.js** (marked) - Markdown parsing
- **PixiJS** (@pixi/*) - Canvas rendering for Neovim
- **DOMPurify** (dompurify) - HTML sanitization
- **lodash** - Utility functions
- **aws4fetch** - AWS API authentication
- **msgpack** (@msgpack/msgpack) - Binary serialization

### Browser APIs
- Tabs, Windows, Bookmarks, History
- Storage (local + sync)
- Runtime (messaging)
- Native Messaging (Neovim)
- Proxy (Chrome only)
- Clipboard, Downloads

### Communication Protocols
- postMessage (Content ↔ Frontend UI)
- chrome.runtime.sendMessage (Content ↔ Background)
- WebSocket (Neovim Terminal ↔ Neovim)
- HTTP/REST (Background ↔ LLM providers)
- Native Messaging (Background ↔ Native apps)

---

## Related Documentation

- **C1 - System Context**: (To be created)
- **C2 - Container Diagram**: `docs/c4/c2.md`
- **C4 - Code Diagram**: (To be created)
- **Feature Tree**: `docs/feature-tree.md`
- **API Documentation**: `docs/API.md`

---

**Document Metadata**:
- **Generated**: 2026-01-20
- **Source**: Surfingkeys v1.17.12 codebase analysis
- **Methodology**: C4 Model - Level 3 (Component Diagram)
- **Containers Covered**: 8 containers, 60+ components
- **Total Lines of Code**: ~15,000 LOC analyzed
