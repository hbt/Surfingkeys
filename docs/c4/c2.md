# C4 Model - Level 2: Container Diagram

**System**: Surfingkeys Browser Extension
**Diagram Level**: C2 - Container
**Version**: 1.17.12
**Last Updated**: 2026-01-20

## Overview

This diagram shows the high-level shape of the Surfingkeys architecture and how responsibilities are distributed across containers. A container is a separately runnable/deployable unit that executes code or stores data.

## Container Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              Browser User                                │
│                     [Person: Web Browser User]                          │
└────────────┬─────────────────────────────────────┬──────────────────────┘
             │                                     │
             │ Interacts via                       │ Configures via
             │ keyboard/mouse                      │ extension popup
             │                                     │
             ▼                                     ▼
┌─────────────────────────────────────┐  ┌────────────────────────────┐
│        Web Page Context             │  │    Popup Interface         │
│   [External: Browser Tab]           │  │   [Container: HTML/JS]     │
│                                     │  │                            │
│  Where user browses content         │  │  - Quick status display    │
└────────────┬────────────────────────┘  │  - Basic controls          │
             │                            │                            │
             │ Injects into               │  Technology: HTML, CSS, JS │
             │                            └────────────┬───────────────┘
             ▼                                         │
┌─────────────────────────────────────┐               │ Communicates via
│      Content Script Engine          │               │ browser.runtime API
│   [Container: JavaScript]           │               │
│                                     │               │
│  Main orchestrator injected into    │◄──────────────┘
│  every web page                     │
│                                     │
│  Responsibilities:                  │
│  - Keyboard event capture           │
│  - Mode management (Normal/Visual)  │
│  - Hints generation & overlay       │
│  - DOM manipulation                 │
│  - Page interaction coordination    │
│                                     │
│  Technology: JavaScript             │
└──────┬──────────────┬───────────────┘
       │              │
       │              │ Creates iframes
       │              │ & injects
       │              │
       │              ▼
       │   ┌────────────────────────────────┐
       │   │   Frontend UI Frame            │
       │   │  [Container: HTML/JS/CSS]      │
       │   │                                │
       │   │  Isolated UI rendering layer   │
       │   │                                │
       │   │  Responsibilities:             │
       │   │  - Omnibar (search interface)  │
       │   │  - Hints display overlay       │
       │   │  - Status bar                  │
       │   │  - Visual mode indicators      │
       │   │  - Help popup                  │
       │   │  - LLM chat interface          │
       │   │                                │
       │   │  Technology: HTML, CSS, JS     │
       │   └───────┬────────────────────────┘
       │           │
       │           │ Communicates via
       │           │ postMessage API
       │           │
       ├───────────┴─────────────────────────┐
       │                                     │
       │ Sends commands via                  │ Requests data
       │ browser.runtime.sendMessage         │
       │                                     │
       ▼                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                   Background Service Worker                              │
│                  [Container: JavaScript]                                 │
│                                                                          │
│  Central coordinator for browser-level operations                       │
│                                                                          │
│  Responsibilities:                                                       │
│  - Tab management (open, close, switch, organize)                       │
│  - Window management (move tabs, gather, new window)                    │
│  - Bookmark operations (search, create, delete)                         │
│  - History access and management                                        │
│  - Session management (save, restore)                                   │
│  - Proxy configuration (Chrome only)                                    │
│  - Extension settings coordination                                      │
│  - Native messaging bridge to Neovim                                    │
│  - LLM provider API integration                                         │
│  - Command execution engine                                             │
│  - Download management                                                  │
│                                                                          │
│  Technology: JavaScript (Service Worker/Background Script)              │
└──────┬────────────┬──────────────┬──────────────┬────────────┬─────────┘
       │            │              │              │            │
       │            │              │              │            │
       │ Reads/     │ Manages      │ Communicates │ HTTP      │ Native
       │ Writes     │              │              │ Requests  │ Messaging
       │            │              │              │           │
       ▼            ▼              ▼              ▼           ▼
┌──────────┐ ┌──────────┐  ┌──────────────┐ ┌─────────┐ ┌──────────┐
│ Browser  │ │ Browser  │  │ Specialized  │ │   LLM   │ │ Neovim   │
│ Storage  │ │ APIs     │  │ Pages        │ │Provider │ │ Process  │
│          │ │          │  │              │ │ APIs    │ │          │
│[Data     │ │[External]│  │[Containers]  │ │[Ext.]   │ │[External]│
│ Store]   │ │          │  │              │ │         │ │          │
│          │ │          │  │              │ │         │ │          │
│- Settings│ │- Tabs    │  │              │ │- Ollama │ │Terminal  │
│- Sessions│ │- History │  │  ┌─────────┐ │ │- Bedrock│ │emulator  │
│- Marks   │ │- Bkmrks  │  │  │ PDF     │ │ │- DeepSk │ │for text  │
│- Proxy   │ │- Windows │  │  │ Viewer  │ │ │- Gemini │ │editing   │
│- User    │ │- Storage │  │  │  Page   │ │ │- Custom │ │          │
│  Config  │ │- Download│  │  ├─────────┤ │ │  APIs   │ │Tech:     │
│- Blocklst│ │- TopSites│  │  │Tech:    │ │ │         │ │Neovim    │
│          │ │- Sessions│  │  │PDF.js   │ │ │Tech:    │ │over      │
│Tech:     │ │- Clipboard│ │  │Viewer   │ │ │HTTP     │ │WebSocket │
│chrome.   │ │          │  │  │HTML/JS  │ │ │REST API │ │or stdin  │
│storage   │ │Tech:     │  │  └─────────┘ │ │         │ │          │
│          │ │chrome.*  │  │              │ │         │ │          │
│Sync:     │ │browser.* │  │  ┌─────────┐ │ │         │ │          │
│Chrome,   │ │          │  │  │Markdown │ │ │         │ │          │
│Safari    │ │          │  │  │ Preview │ │ │         │ │          │
└──────────┘ └──────────┘  │  │  Page   │ │ │         │ │          │
                           │  ├─────────┤ │ │         │ │          │
                           │  │Tech:    │ │ │         │ │          │
                           │  │marked.js│ │ │         │ │          │
                           │  │or GH API│ │ │         │ │          │
                           │  │HTML/CSS │ │ │         │ │          │
                           │  └─────────┘ │ │         │ │          │
                           │              │ │         │ │          │
                           │  ┌─────────┐ │ │         │ │          │
                           │  │ Options │ │ │         │ │          │
                           │  │Settings │ │ │         │ │          │
                           │  │  Page   │ │ │         │ │          │
                           │  ├─────────┤ │ │         │ │          │
                           │  │Tech:    │ │ │         │ │          │
                           │  │HTML/JS  │ │         │ │          │
                           │  │ACE      │ │ │         │ │          │
                           │  │Editor   │ │ │         │ │          │
                           │  └─────────┘ │ │         │ │          │
                           │              │ │         │ │          │
                           │  ┌─────────┐ │ │         │ │          │
                           │  │ Neovim  │ │ │         │ │          │
                           │  │Terminal │ │ │         │ │          │
                           │  │  Page   │ │ │         │ │          │
                           │  ├─────────┤ │ │         │ │          │
                           │  │Tech:    │ │         │ │          │
                           │  │PixiJS   │ │ │         │ │          │
                           │  │Canvas   │ │ │         │ │          │
                           │  │WebSocket│ │ │         │ │          │
                           │  └─────────┘ │ │         │ │          │
                           └──────────────┘ └─────────┘ └──────────┘
```

## Container Details

### c2.containers

#### c2.containers.content-script

**Container**: Content Script Engine
**Type**: JavaScript Module (Injected)
**Technology**: Vanilla JavaScript
**Source**: `src/content_scripts/content.js`, `src/content_scripts/common/`

**Purpose**: Main orchestration layer that runs in every web page context

**Responsibilities**:
- Keyboard event capture and processing
- Mode state management (Normal, Visual, Insert, Hints, PassThrough, Lurk)
- Hints generation and link detection
- Visual mode text selection
- Find-in-page functionality
- Clipboard operations (copy/paste)
- Page scrolling and navigation
- Frame switching coordination
- DOM manipulation for page interaction
- Vim-like marks management
- Repeat command handling (dot operator)
- Search selected text coordination

**Key Components**:
- `default.js` - 142+ default keyboard mappings
- `api.js` - User-facing API for customization
- `normal.js` - Normal mode operations
- `visual.js` - Visual mode text selection
- `hints.js` - Hints mode link following
- `clipboard.js` - Clipboard operations

**Communication**:
- Sends messages to Background Service via `browser.runtime.sendMessage()`
- Creates and manages Frontend UI Frame via iframe injection
- Communicates with UI Frame via `postMessage()`
- Responds to commands from Background Service

**Lifecycle**: Injected at `document_start`, runs in all frames

---

#### c2.containers.frontend-ui

**Container**: Frontend UI Frame
**Type**: Web Page (Iframe)
**Technology**: HTML, CSS, JavaScript
**Source**: `src/pages/frontend.html`, `src/content_scripts/front.js`

**Purpose**: Isolated UI rendering layer for Surfingkeys visual interface

**Responsibilities**:
- Omnibar rendering and interaction (URL/bookmark/tab/command search)
- Hints display overlay (link labels)
- Status bar display (mode indicators)
- Visual mode indicators
- Help popup rendering (keyboard shortcuts)
- Banner notifications
- LLM chat interface
- Find bar interface
- Editor UI (ACE vim/emacs editor)

**Key Features**:
- Shadow DOM isolation for style encapsulation
- Keyboard input capture for omnibar
- Real-time search result filtering
- Tab completion UI
- Emoji picker interface
- Rich hints display (keyboard help tooltips)

**Communication**:
- Receives commands from Content Script via `postMessage()`
- Sends user actions back to Content Script
- Isolated from page JavaScript for security

**Rendering**: Created as `<iframe>` in page DOM with `frontend.html` as source

---

#### c2.containers.background

**Container**: Background Service Worker
**Type**: Service Worker / Background Script
**Technology**: JavaScript
**Source**: `src/background/start.js`, `src/background/chrome.js`, `src/background/firefox.js`, `src/background/safari.js`

**Purpose**: Central coordinator for browser-level operations and extension lifecycle

**Responsibilities**:
- **Tab Management**: Create, close, switch, duplicate, pin, mute, move, organize tabs
- **Window Management**: Move tabs between windows, create windows, gather tabs
- **Bookmark Operations**: Search, create, delete bookmarks; vim-like marks
- **History Management**: Access browsing history, backup/restore
- **Session Management**: Save/restore tab sessions, named sessions
- **Proxy Configuration**: Set proxy modes (Chrome only), per-site proxy settings
- **Settings Coordination**: Manage extension settings, sync across devices
- **Download Management**: Handle file downloads
- **Command Execution**: Process commands from Omnibar (`:` commands)
- **Native Messaging**: Bridge to external Neovim process
- **LLM Integration**: Coordinate with LLM provider APIs
- **Extension Lifecycle**: Handle install, update, restart events

**Browser API Usage**:
- `chrome.tabs.*` / `browser.tabs.*` - Tab operations
- `chrome.windows.*` - Window management
- `chrome.bookmarks.*` - Bookmark operations
- `chrome.history.*` - History access
- `chrome.storage.*` - Persistent storage
- `chrome.sessions.*` - Session management
- `chrome.proxy.*` - Proxy settings (Chrome only)
- `chrome.downloads.*` - Download management
- `chrome.runtime.*` - Messaging and lifecycle
- `browser.nativeMessaging` - Neovim communication

**Communication**:
- Receives messages from Content Script via `chrome.runtime.onMessage`
- Sends commands to Content Script via `chrome.tabs.sendMessage()`
- Reads/writes to Browser Storage
- Makes HTTP requests to LLM APIs
- Communicates with Neovim via native messaging

**Lifecycle**: Persistent background script (Manifest V2) or service worker (Manifest V3)

---

#### c2.containers.popup

**Container**: Popup Interface
**Type**: Web Page
**Technology**: HTML, CSS, JavaScript
**Source**: `src/pages/popup.html`, `src/pages/popup.js`

**Purpose**: Quick access interface via browser extension icon

**Responsibilities**:
- Display extension status (enabled/lurking/disabled)
- Quick toggle controls
- Link to settings page
- Visual feedback for current site status

**Communication**:
- Reads settings from Browser Storage
- Sends commands to Background Service

**Lifecycle**: Created when user clicks extension icon

---

#### c2.containers.options-page

**Container**: Options/Settings Page
**Type**: Web Page
**Technology**: HTML, CSS, JavaScript, ACE Editor
**Source**: `src/pages/options.html`, `src/content_scripts/options.js`

**Purpose**: Full-featured settings editor for user configuration

**Responsibilities**:
- Settings editor with syntax highlighting (ACE Editor)
- JavaScript configuration editing
- Key mapping customization
- Search engine configuration
- Theme customization
- Settings import/export
- Settings validation

**Key Features**:
- Vim/Emacs keybindings in editor
- Live syntax checking
- Settings documentation
- Reset to defaults
- Example snippets

**Communication**:
- Reads/writes to Browser Storage
- Uses Background Service for validation

**Access**: Via `;e` shortcut or browser extension settings

---

#### c2.containers.pdf-viewer

**Container**: PDF Viewer Page
**Type**: Web Page
**Technology**: HTML, CSS, JavaScript, PDF.js
**Source**: `src/pages/pdf_viewer.html`, `src/pages/pdf_viewer.mjs`
**Browser Support**: Chrome/Chromium only

**Purpose**: Custom PDF viewer with full keyboard navigation

**Responsibilities**:
- Render PDF documents using PDF.js
- Full keyboard navigation support (all Surfingkeys shortcuts)
- Page navigation (next/prev, jump to page)
- Zoom control
- Search within PDF
- Annotations support
- Toggle between custom and native viewer

**Key Features**:
- Smooth scrolling in PDFs
- Visual mode for text selection
- Hints mode for PDF links
- Omnibar for page navigation
- All Surfingkeys features work in PDFs

**Communication**:
- Loads PDF via URL parameter
- Integrates with Content Script for keyboard handling
- Uses PDF.js worker for rendering

**Activation**: Automatically intercepts PDF URLs in Chrome

---

#### c2.containers.markdown-preview

**Container**: Markdown Preview Page
**Type**: Web Page
**Technology**: HTML, CSS, JavaScript, marked.js
**Source**: `src/pages/markdown.html`, `src/content_scripts/markdown.js`

**Purpose**: Preview markdown content with live editing

**Responsibilities**:
- Parse markdown (local via marked.js or GitHub API)
- Render formatted markdown as HTML
- Live editing with vim editor
- Reload from clipboard
- Export to HTML
- Syntax highlighting for code blocks

**Key Features**:
- `;pm` to preview markdown from clipboard
- Edit markdown source in vim editor
- `:wq` to refresh preview
- `r` to reload from clipboard
- Theme support

**Communication**:
- Reads clipboard content
- Parses locally or via GitHub API
- Uses Content Script for editor integration

**Access**: Via `;pm` shortcut

---

#### c2.containers.neovim-terminal

**Container**: Neovim Terminal Page
**Type**: Web Page
**Technology**: HTML, JavaScript, PixiJS, WebSocket
**Source**: `src/pages/neovim.html`, `src/nvim/`
**Browser Support**: Chrome/Chromium only

**Purpose**: Full Neovim terminal emulator for text editing

**Responsibilities**:
- Terminal rendering with PixiJS canvas
- Neovim UI protocol implementation
- Keyboard/mouse input forwarding
- WebSocket communication with Neovim process
- Screen rendering and updates

**Key Features**:
- Full Neovim functionality
- True color support
- Mouse support
- Clipboard integration
- Smooth rendering

**Communication**:
- WebSocket to local Neovim process via native messaging bridge
- Background Service coordinates native messaging
- PixiJS for GPU-accelerated rendering

**Activation**: When editing input fields with Neovim enabled

---

#### c2.containers.browser-storage

**Data Store**: Browser Storage
**Type**: Browser Extension Storage API
**Technology**: `chrome.storage.local`, `chrome.storage.sync`

**Purpose**: Persistent data storage for extension state and user configuration

**Data Stored**:
- User settings and configuration
- Saved sessions (tab URLs)
- Vim-like marks (URL bookmarks)
- Proxy configuration (Chrome only)
- User custom scripts
- Blocklist/lurking patterns
- Search engine aliases
- Key mappings
- Theme settings
- LLM provider credentials

**Storage Types**:
- **Local Storage**: Non-synced data, larger quota
- **Sync Storage**: Synced across devices (Chrome, Safari)

**Access**: Via `chrome.storage.*` API from Background Service and other containers

**Backup**: Settings can be exported/imported via Omnibar commands

---

#### c2.containers.browser-apis

**External System**: Browser APIs
**Type**: Browser-provided APIs
**Technology**: WebExtension APIs (`chrome.*`, `browser.*`)

**Purpose**: Interface to browser functionality

**APIs Used**:
- **Tabs API**: Tab lifecycle, navigation, organization
- **Windows API**: Window management, focus
- **Bookmarks API**: Bookmark CRUD operations
- **History API**: Browsing history access
- **Storage API**: Persistent data storage
- **Sessions API**: Recent tab/window state
- **Downloads API**: File download management
- **TopSites API**: Frequently visited sites
- **Clipboard API**: Read/write clipboard
- **Proxy API**: Network proxy configuration (Chrome only)
- **Runtime API**: Extension messaging, lifecycle
- **Commands API**: Keyboard shortcuts
- **NativeMessaging API**: Communication with native apps

**Access**: All containers can use browser APIs within their permission scope

---

#### c2.containers.llm-providers

**External System**: LLM Provider APIs
**Type**: HTTP REST APIs
**Technology**: HTTP/HTTPS, WebSocket (Ollama)
**Source**: `src/background/llm.js`

**Purpose**: AI/LLM integration for chat features

**Supported Providers**:
- **Ollama**: Local LLM, HTTP API, `http://localhost:11434`
- **AWS Bedrock**: Claude models, AWS Signature V4 authentication
- **DeepSeek**: DeepSeek models, API key authentication
- **Gemini**: Google Gemini models, API key authentication
- **Custom**: OpenAI-compatible APIs (SiliconFlow, OpenRouter, etc.)

**Features**:
- Chat with selected text or page content
- Regional Hints chat integration (`L` then `l`)
- Custom system prompts
- Streaming responses
- Tool/function calling support

**Communication**:
- Background Service makes HTTP requests to provider APIs
- Credentials stored in Browser Storage
- Responses streamed to Frontend UI chat interface

**Configuration**: Via settings with API keys/credentials

---

#### c2.containers.neovim-process

**External System**: Neovim Process
**Type**: Native Application
**Technology**: Neovim, Native Messaging Protocol, WebSocket
**Browser Support**: Chrome/Chromium only

**Purpose**: Full-featured text editor for advanced editing

**Features**:
- Complete Neovim functionality
- Plugins and extensions
- Lua scripting
- Custom init.vim/init.lua
- All Neovim keybindings

**Communication Flow**:
1. User activates Neovim editor (`Ctrl-i` in input field)
2. Content Script requests Neovim Terminal page
3. Background Service establishes native messaging connection
4. Neovim Terminal page connects via WebSocket
5. Input forwarded to Neovim, output rendered in terminal

**Requirements**:
- Neovim installed locally
- Native messaging host configured
- Chrome/Chromium browser

**Fallback**: ACE vim editor used if Neovim unavailable

---

## Container Interactions

### c2.interactions

#### c2.interactions.keyboard-flow

**Primary User Flow: Keyboard Shortcut Execution**

```
User (Keyboard) → Web Page Context → Content Script Engine
                                          │
                                          ├─→ [Local handling]
                                          │   - Scrolling
                                          │   - Hints display
                                          │   - Visual mode
                                          │
                                          ├─→ Frontend UI Frame
                                          │   - Omnibar search
                                          │   - Help display
                                          │
                                          └─→ Background Service
                                              - Tab operations
                                              - Bookmarks
                                              - History
```

#### c2.interactions.omnibar-search

**Omnibar Search Flow**

```
User types 't' → Content Script → Frontend UI (Omnibar)
                                       │
                                       └─→ Background Service
                                           - Query bookmarks
                                           - Query history
                                           - Return results
                                           │
                                           ▼
                                   Frontend UI (display)
                                           │
User selects result                        │
                                           ▼
                                   Background Service
                                   - Open URL in tab
```

#### c2.interactions.llm-chat

**LLM Chat Flow**

```
User selects text → Press 'A' → Frontend UI (chat interface)
                                     │
                                     └─→ Background Service
                                         - Prepare context
                                         - Call LLM Provider API
                                         - Stream response
                                         │
                                         ▼
                                 Frontend UI (display chat)
```

#### c2.interactions.settings-sync

**Settings Synchronization**

```
User edits settings → Options Page
                          │
                          └─→ Browser Storage (sync)
                              - Save settings
                              - Trigger sync
                              │
                              ▼
                       Other devices (Chrome/Safari)
                       Background Service loads settings
                              │
                              └─→ Content Scripts apply settings
```

---

## Technology Stack

### c2.tech

#### c2.tech.core

**Core Technologies**:
- JavaScript (ES6+) - Primary language
- HTML5 - UI pages
- CSS3 - Styling with Shadow DOM isolation
- WebExtension APIs - Browser integration

#### c2.tech.libraries

**Key Libraries**:
- **ACE Editor** (`ace-builds`) - Vim/Emacs editor for settings and text input
- **PDF.js** (`pdfjs-dist`) - PDF rendering and parsing
- **marked.js** (`marked`) - Markdown parsing
- **PixiJS** (`@pixi/*`) - Canvas rendering for Neovim terminal
- **DOMPurify** (`dompurify`) - HTML sanitization
- **lodash** - Utility functions
- **aws4fetch** - AWS API authentication
- **msgpack** - Binary serialization for Neovim

#### c2.tech.apis

**Browser APIs**:
- Storage API (local + sync)
- Tabs API
- Windows API
- Bookmarks API
- History API
- Runtime Messaging API
- Native Messaging API (Neovim)
- Proxy API (Chrome only)
- Clipboard API

#### c2.tech.protocols

**Communication Protocols**:
- `postMessage()` - Content Script ↔ Frontend UI Frame
- `chrome.runtime.sendMessage()` - Content Script ↔ Background Service
- `chrome.tabs.sendMessage()` - Background Service → Content Script
- WebSocket - Neovim Terminal ↔ Neovim Process
- Native Messaging - Background Service ↔ Native apps
- HTTP/REST - Background Service ↔ LLM Providers

---

## Deployment Model

### c2.deployment

#### c2.deployment.extension-package

**Distribution**: Browser extension package (ZIP/CRX/XPI)

**Contents**:
- Manifest file (`manifest.json`)
- Background scripts bundle
- Content scripts bundle
- UI pages (HTML/CSS/JS)
- Icons and assets
- Web accessible resources

**Installation**:
- Chrome Web Store (Chrome/Edge)
- Firefox Add-ons (Firefox)
- Mac App Store (Safari)

#### c2.deployment.runtime

**Runtime Environment**: Browser extension sandbox

**Execution Contexts**:
1. **Background Context**: Service worker, single instance per extension
2. **Content Context**: Injected into every web page/frame
3. **Page Context**: Separate pages (options, PDF viewer, etc.)
4. **Popup Context**: Temporary popup window

**Isolation**:
- Content scripts isolated from page JavaScript
- UI Frame uses Shadow DOM for style isolation
- Browser Storage isolated per extension

---

## Security Architecture

### c2.security

#### c2.security.isolation

**Isolation Boundaries**:
- Content scripts cannot access page JavaScript variables directly
- Frontend UI Frame runs in isolated iframe with restricted CSP
- Background Service has elevated permissions, content scripts limited
- Shadow DOM prevents CSS conflicts
- DOMPurify sanitizes user-generated HTML

#### c2.security.permissions

**Extension Permissions** (from manifest.json):
- `tabs` - Tab access (required for tab operations)
- `history` - History access (required for URL search)
- `bookmarks` - Bookmark access (required for bookmark operations)
- `storage` - Persistent storage
- `sessions` - Recent tabs/windows
- `downloads` - Download management
- `clipboardRead` / `clipboardWrite` - Clipboard operations
- `nativeMessaging` - Neovim communication
- `scripting` - Script injection

#### c2.security.csp

**Content Security Policy**:
```
script-src 'self'; object-src 'self'
```
- Only allow scripts from extension package
- No inline scripts (eval, inline event handlers)
- No external script loading

#### c2.security.data-handling

**Sensitive Data**:
- LLM API keys stored in encrypted Browser Storage
- Settings sync respects browser's sync encryption
- Clipboard data handled temporarily, not persisted
- No data sent to external servers except user-configured LLM APIs

---

## Browser Compatibility

### c2.compatibility

| Container | Chrome/Chromium | Firefox | Safari |
|-----------|----------------|---------|--------|
| Content Script Engine | ✓ Full | ✓ Full | ✓ Full |
| Frontend UI Frame | ✓ Full | ✓ Full | ⚠ Partial* |
| Background Service | ✓ Full | ✓ Partial** | ✓ Partial** |
| Popup Interface | ✓ Full | ✓ Full | ✓ Full |
| Options Page | ✓ Full | ✓ Full | ✓ Full |
| PDF Viewer | ✓ Full | ✗ None | ✗ None |
| Markdown Preview | ✓ Full | ✓ Full | ✗ None |
| Neovim Terminal | ✓ Full | ✗ None | ✗ None |
| Browser Storage | ✓ Sync | ✓ Local | ✓ Sync |
| LLM Integration | ✓ Full | ✓ Full | ✓ Full |

*Safari Omnibar has limited functionality
**Firefox/Safari lack window management, proxy, tab groups

---

## Performance Characteristics

### c2.performance

#### c2.performance.content-script

**Content Script Engine**:
- **Initialization**: < 50ms per page
- **Memory footprint**: ~5-10MB per tab
- **Event handling**: < 5ms latency for keyboard events
- **Hints generation**: < 100ms for typical page (100s of links)
- **Optimization**: Trie-based key lookup, lazy loading of features

#### c2.performance.background

**Background Service**:
- **Memory footprint**: ~20-30MB (persistent)
- **Tab operations**: < 10ms (native browser API)
- **Storage access**: < 5ms (cached)
- **LLM API**: 100ms - 5s (network dependent)

#### c2.performance.ui

**Frontend UI Frame**:
- **Render time**: < 16ms (60 FPS target)
- **Omnibar search**: < 50ms for 1000s of results
- **Memory**: ~5MB per tab
- **Isolation**: No impact on page performance

---

## Scaling Considerations

### c2.scaling

#### c2.scaling.tabs

**Tab Scaling**:
- Content Script injected into every tab/frame
- Memory per tab: ~5-15MB depending on page complexity
- Tested with 100+ tabs
- Threshold setting (`tabsThreshold`) switches to omnibar for large tab counts

#### c2.scaling.storage

**Storage Scaling**:
- Settings: < 100KB typically
- Sessions: ~1KB per tab URL
- Marks: ~100 bytes per mark
- Total quota: 5MB (local), 100KB (sync)

#### c2.scaling.performance

**Performance Optimization**:
- Trie data structure for fast key lookup
- Lazy loading of non-critical features
- Debounced event handlers
- Efficient DOM queries with caching
- RequestAnimationFrame for smooth animations

---

## Future Considerations

### c2.future

#### c2.future.manifest-v3

**Manifest V3 Migration**:
- Service Worker replaces persistent background page
- Reduced memory footprint
- More aggressive lifecycle management
- Requires refactoring for event-driven architecture

#### c2.future.modularization

**Potential Modularization**:
- Split large containers into smaller modules
- Plugin architecture for features
- Lazy-load optional features (PDF, Neovim, LLM)
- Reduce core bundle size

#### c2.future.web-components

**Web Components**:
- Replace iframe-based UI with Web Components
- Better encapsulation
- Improved performance
- Native Shadow DOM support

---

## Related Documentation

- **C1 - System Context**: (To be created) - How Surfingkeys fits into browser ecosystem
- **C3 - Component Diagram**: (To be created) - Detailed breakdown of container internals
- **C4 - Code Diagram**: (To be created) - Class-level details
- **API Documentation**: `docs/API.md`
- **Feature Tree**: `docs/feature-tree.md`

---

**Document Metadata**:
- **Generated**: 2026-01-20
- **Source**: Surfingkeys v1.17.12 codebase analysis
- **Methodology**: C4 Model - Level 2 (Container Diagram)
- **Notation**: ASCII art + structured descriptions
- **Key files analyzed**: manifest.json, background/start.js, content_scripts/, pages/
